# 10.3 useInfiniteScroll

## 1. 实现思路

利用 IntersectionObserver 监听底部元素，触发加载更多。

## 2. 代码实现

```typescript
import { useEffect, useRef, useState } from 'react';

function useInfiniteScroll(loadMore: () => Promise<void>, hasMore: boolean) {
  const [loading, setLoading] = useState(false);
  const observerRef = useRef<IntersectionObserver>();
  const targetRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (loading || !hasMore) return;

    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        setLoading(true);
        loadMore().finally(() => setLoading(false));
      }
    }, { threshold: 1.0 });

    if (targetRef.current) {
      observer.observe(targetRef.current);
    }
    observerRef.current = observer;

    return () => {
      if (observerRef.current) observerRef.current.disconnect();
    };
  }, [loadMore, hasMore, loading]);

  return targetRef;
}

export default useInfiniteScroll;
```

## 3. 使用示例

```tsx
import { useState } from 'react';
import useInfiniteScroll from './useInfiniteScroll';

function List() {
  const [items, setItems] = useState([1, 2, 3]);
  const [hasMore, setHasMore] = useState(true);

  const loadMore = async () => {
    // 模拟 API
    await new Promise(resolve => setTimeout(resolve, 1000));
    setItems(prev => [...prev, ...[4, 5, 6]]);
    if (items.length > 20) setHasMore(false);
  };

  const targetRef = useInfiniteScroll(loadMore, hasMore);

  return (
    <div>
      {items.map(item => <div key={item} style={{height: 100}}>{item}</div>)}
      {hasMore && <div ref={targetRef}>Loading more...</div>}
    </div>
  );
}
```

## 4. 常见问题

- **性能优化**：确保 loadMore 函数引用稳定，或者使用 useCallback。
- **阈值设置**：调整 threshold 提前加载。
