# 19.3 中间件


Zustand 通过中间件扩展功能，遵循洋葱模型。

## 1. persist (持久化)

自动保存状态到 `localStorage` / `sessionStorage`。

```javascript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

const useStore = create(
  persist(
    (set) => ({
      bears: 0,
      addBear: () => set({ bears: 1 }),
    }),
    {
      name: 'food-storage', // 必填，localStorage key
      storage: createJSONStorage(() => sessionStorage), // 可选，默认 localStorage
      partialize: (state) => ({ bears: state.bears }), // 可选，只持久化部分字段
    }
  )
);
```

## 2. immer (不可变更新)

允许直接修改 state（类似于 Vue/MobX）。

```javascript
import { immer } from 'zustand/middleware/immer';

const useStore = create(
  immer((set) => ({
    todos: [],
    addTodo: (text) =>
      set((state) => {
        state.todos.push({ text, done: false }); // 直接修改
      }),
  }))
);
```

## 3. devtools (调试)

连接 Redux DevTools Extension。

```javascript
import { devtools } from 'zustand/middleware';

const useStore = create(devtools(store, { name: 'MyStore' }));
```
