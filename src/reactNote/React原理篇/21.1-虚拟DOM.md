# 虚拟 DOM (Virtual DOM)

虚拟 DOM 是 React 的核心概念之一，它是一个用 JavaScript 对象来描述真实 DOM 的编程概念。

## 1. 核心概念

### 1.1 什么是虚拟 DOM
虚拟 DOM 本质上是一个普通的 JavaScript 对象，它包含了描述 DOM 节点所需的信息（如标签名、属性、子节点等）。

### 1.2 为什么需要虚拟 DOM
1.  **跨平台能力**：虚拟 DOM 是一个抽象层，可以映射到不同的渲染目标（Web、iOS、Android）。
2.  **性能优化**：通过 Diff 算法比较新旧虚拟 DOM，只更新变化的真实 DOM，减少昂贵的 DOM 操作。
3.  **开发体验**：支持声明式编程，开发者只需关注状态变化，无需手动操作 DOM。

## 2. 模拟实现

### 2.1 VNode 结构
最简单的 VNode 结构包含 type, props, children。

```javascript
// 创建虚拟 DOM 的函数
function createElement(type, props, ...children) {
  return {
    type,
    props: {
      ...props,
      children: children.map(child =>
        typeof child === "object"
          ? child
          : createTextElement(child)
      ),
    },
  };
}

// 处理文本节点
function createTextElement(text) {
  return {
    type: "TEXT_ELEMENT",
    props: {
      nodeValue: text,
      children: [],
    },
  };
}

// 示例使用
const element = createElement(
  "div",
  { id: "foo" },
  createElement("a", null, "bar"),
  createElement("b")
);

console.log(element);
```

### 2.2 Render 函数
将虚拟 DOM 转换为真实 DOM。

```javascript
function render(element, container) {
  // 1. 创建 DOM 节点
  const dom =
    element.type === "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(element.type);

  // 2. 添加属性
  const isProperty = key => key !== "children";
  Object.keys(element.props)
    .filter(isProperty)
    .forEach(name => {
      dom[name] = element.props[name];
    });

  // 3. 递归处理子节点
  element.props.children.forEach(child =>
    render(child, dom)
  );

  // 4. 挂载到容器
  container.appendChild(dom);
}
```

## 3. 常见问题

### Q: 虚拟 DOM 一定比直接操作 DOM 快吗？
**A: 不一定。**
- **首次渲染**：虚拟 DOM 需要创建 JS 对象树，再转换成真实 DOM，比直接操作 DOM 慢。
- **大量更新**：如果每次更新都全量替换，虚拟 DOM 也不一定快。
- **少量更新**：虚拟 DOM 的优势在于通过 Diff 算法找出最小变更，避免了不必要的 DOM 操作。
- **核心价值**：虚拟 DOM 的最大价值在于**可维护性**（声明式编程）和**跨平台能力**，性能只是在某些场景下的附带红利（保证了性能下限）。

### Q: React 的 createElement 和 JSX 的关系？
**A:** JSX 是语法糖，编译时会被 Babel 转译为 `React.createElement` 调用。
```javascript
// JSX
const element = <div className="foo">Hello</div>;

// Transpiled
const element = React.createElement(
  'div',
  { className: 'foo' },
  'Hello'
);
```
