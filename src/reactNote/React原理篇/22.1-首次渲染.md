# 首次渲染流程

React 的首次渲染（Mount）是将组件树转换为真实 DOM 并显示在屏幕上的过程。在 Fiber 架构下，这个过程严格遵循 Render（计算）和 Commit（提交）两个阶段。

## 1. 整体流程
1.  **创建根节点**：`createRoot` 创建 FiberRoot 和 HostRootFiber。
2.  **Render 阶段**：从根节点开始，深度优先遍历，构建 Fiber 树，生成 DOM 节点。
3.  **Commit 阶段**：将生成的 DOM 树一次性挂载到容器中。

## 2. Render 阶段 (beginWork & completeWork)
这是一个“归”和“递”的过程。

### 2.1 beginWork (递 - 向下遍历)
从父节点到子节点，主要做两件事：
1.  **处理当前节点**：如果是函数组件执行函数，如果是类组件执行 render，如果是 Host 组件创建/更新 props。
2.  **Reconcile (协调)**：根据子元素的 ReactElement 创建子 Fiber 节点。

```javascript
function beginWork(current, workInProgress, renderLanes) {
  switch (workInProgress.tag) {
    case FunctionComponent:
      return updateFunctionComponent(...);
    case ClassComponent:
      return updateClassComponent(...);
    case HostComponent: // div, span...
      return updateHostComponent(...);
    // ...
  }
}
```

### 2.2 completeWork (归 - 向上回溯)
当一个节点没有子节点（或子节点已处理完），进入 `completeWork`：
1.  **创建 DOM**：为 HostComponent 创建真实 DOM 节点。
2.  **处理 Props**：初始化 DOM 属性、事件监听。
3.  **构建 DOM 树**：将子 DOM 节点插入到当前 DOM 节点中（`appendAllChildren`）。这使得 DOM 树在内存中构建完成，Commit 阶段只需一次插入。
4.  **收集副作用**：构建副作用链表（Effect List，React 18 改为 subtreeFlags）。

## 3. Commit 阶段
Render 阶段完成后，得到了一棵带有副作用标记的 Fiber 树。Commit 阶段负责将这些副作用应用到真实 DOM。

### 3.1 Before Mutation 阶段
*   执行 `getSnapshotBeforeUpdate`（类组件）。
*   调度 `useEffect`（异步执行）。

### 3.2 Mutation 阶段
*   执行 DOM 操作（Placement, Update, Deletion）。
*   置空 Ref。

### 3.3 Layout 阶段
*   此时 DOM 已经更新。
*   执行 `useLayoutEffect`（同步）。
*   执行 `componentDidMount` / `componentDidUpdate`。
*   更新 Ref。

## 4. 模拟实现：递归构建 Fiber 树

```javascript
// 简化版 Render 阶段
function performUnitOfWork(fiber) {
  // 1. beginWork: 创建子节点
  if (!fiber.child) {
    const elements = fiber.props.children;
    reconcileChildren(fiber, elements);
  }

  // 2. 如果有子节点，继续向下
  if (fiber.child) return fiber.child;

  // 3. completeWork: 如果没有子节点，处理兄弟节点或回溯
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) return nextFiber.sibling;
    nextFiber = nextFiber.return;
  }
  return null;
}
```

## 5. 常见问题
### Q: 为什么首次渲染需要构建 Fiber 树？
**A:** 虽然首次渲染看起来只是简单的创建 DOM，但构建 Fiber 树是为了后续的更新做准备。Fiber 树保存了组件状态、副作用等信息，是 React 运行时的核心数据结构。

### Q: 为什么 DOM 是在 completeWork 阶段构建的？
**A:** 这是一个自底向上的过程。当 `completeWork` 执行时，子节点的 DOM 已经创建好了，可以直接 append 到当前节点的 DOM 上。这样一直回溯到根节点，就形成了一棵完整的离屏 DOM 树。
