# 10.2 useSWR (Simplified)

## 1. 实现思路

实现 SWR (Stale-While-Revalidate) 策略：优先返回缓存数据，同时发起请求更新缓存。

## 2. 代码实现

```typescript
import { useState, useEffect } from 'react';

const cache = new Map();

function useSWR(key: string, fetcher: (key: string) => Promise<any>) {
  const [data, setData] = useState(cache.get(key));
  const [error, setError] = useState(null);

  useEffect(() => {
    let isMounted = true;
    
    const fetchData = async () => {
      try {
        const newData = await fetcher(key);
        if (isMounted) {
          setData(newData);
          cache.set(key, newData);
        }
      } catch (err: any) {
        if (isMounted) setError(err);
      }
    };

    fetchData();

    return () => {
      isMounted = false;
    };
  }, [key, fetcher]);

  return { data, error };
}

export default useSWR;
```

## 3. 使用示例

```tsx
import useSWR from './useSWR';

const fetcher = (url) => fetch(url).then(res => res.json());

function App() {
  const { data, error } = useSWR('https://api.example.com/user', fetcher);

  if (!data) return <div>Loading...</div>;
  return <div>User: {data.name}</div>;
}
```

## 4. 常见问题

- **缓存策略**：这里使用内存 Map 简单实现，生产环境可考虑更复杂的缓存失效策略。
- **去重**：防止重复请求。
