# 3.2 å—æ§ç»„ä»¶ä¸éå—æ§ç»„ä»¶ ğŸŒŸ

## æ¦‚å¿µè®²è§£

**å—æ§ç»„ä»¶ï¼ˆControlled Componentï¼‰**ï¼šè¡¨å•å…ƒç´ çš„å€¼ç”± React çš„ state æ§åˆ¶ï¼Œæ¯æ¬¡è¾“å…¥éƒ½ä¼šè§¦å‘ `onChange` äº‹ä»¶æ›´æ–° stateï¼Œå½¢æˆ"å•ä¸€æ•°æ®æº"ã€‚

**éå—æ§ç»„ä»¶ï¼ˆUncontrolled Componentï¼‰**ï¼šè¡¨å•å…ƒç´ çš„å€¼ç”± DOM è‡ªèº«ç®¡ç†ï¼ŒReact é€šè¿‡ `ref` åœ¨éœ€è¦æ—¶è·å–å€¼ï¼Œæ›´æ¥è¿‘ä¼ ç»Ÿ HTML è¡¨å•ã€‚

---

## å—æ§ç»„ä»¶

### å®ç°æ€è·¯

1. ä½¿ç”¨ `value` å±æ€§ç»‘å®š state
2. é€šè¿‡ `onChange` äº‹ä»¶æ›´æ–° state
3. React å®Œå…¨æ§åˆ¶è¡¨å•å…ƒç´ çš„å€¼

### ä»£ç ç¤ºä¾‹

```jsx
// åŸºç¡€å—æ§è¾“å…¥æ¡†
function ControlledInput() {
  const [value, setValue] = useState('');

  const handleChange = (e) => {
    setValue(e.target.value);
  };

  return (
    <div>
      <input 
        type="text" 
        value={value} 
        onChange={handleChange} 
      />
      <p>å½“å‰å€¼ï¼š{value}</p>
    </div>
  );
}

// å—æ§è¡¨å•ï¼ˆå¤šä¸ªå­—æ®µï¼‰
function ControlledForm() {
  const [formData, setFormData] = useState({
    username: '',
    email: '',
    age: ''
  });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    console.log('æäº¤æ•°æ®ï¼š', formData);
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        name="username"
        value={formData.username}
        onChange={handleChange}
        placeholder="ç”¨æˆ·å"
      />
      <input
        name="email"
        value={formData.email}
        onChange={handleChange}
        placeholder="é‚®ç®±"
      />
      <input
        name="age"
        type="number"
        value={formData.age}
        onChange={handleChange}
        placeholder="å¹´é¾„"
      />
      <button type="submit">æäº¤</button>
    </form>
  );
}
```

### æ¨¡æ‹Ÿå®ç°ï¼šå—æ§ç»„ä»¶æœºåˆ¶

```javascript
// æ¨¡æ‹Ÿå—æ§ç»„ä»¶çš„æ ¸å¿ƒæœºåˆ¶
class ControlledComponentSimulator {
  constructor() {
    this.state = { value: '' };
    this.listeners = [];
  }

  // æ¨¡æ‹Ÿ setState
  setState(newState) {
    this.state = { ...this.state, ...newState };
    this.notifyListeners();
  }

  // æ³¨å†Œç›‘å¬å™¨
  subscribe(listener) {
    this.listeners.push(listener);
  }

  // é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨é‡æ–°æ¸²æŸ“
  notifyListeners() {
    this.listeners.forEach(listener => listener(this.state));
  }

  // æ¨¡æ‹Ÿ onChange å¤„ç†
  handleChange(event) {
    const newValue = event.target.value;
    this.setState({ value: newValue });
  }

  // æ¸²æŸ“å‡½æ•°
  render(container) {
    const input = document.createElement('input');
    input.type = 'text';
    input.value = this.state.value; // å…³é”®ï¼švalue ç”± state æ§åˆ¶
    
    // ç»‘å®šäº‹ä»¶
    input.addEventListener('input', (e) => {
      this.handleChange(e);
    });

    // è®¢é˜…çŠ¶æ€å˜åŒ–
    this.subscribe((state) => {
      input.value = state.value; // çŠ¶æ€æ”¹å˜æ—¶æ›´æ–° DOM
    });

    container.appendChild(input);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const controlled = new ControlledComponentSimulator();
controlled.render(document.getElementById('root'));
```

### å—æ§ç»„ä»¶çš„ä¼˜åŠ¿

- **å®æ—¶éªŒè¯**ï¼šæ¯æ¬¡è¾“å…¥éƒ½å¯ä»¥ç«‹å³éªŒè¯
- **æ¡ä»¶ç¦ç”¨**ï¼šå¯ä»¥æ ¹æ®æ¡ä»¶ç¦ç”¨æäº¤æŒ‰é’®
- **æ ¼å¼åŒ–è¾“å…¥**ï¼šå¯ä»¥åœ¨ç”¨æˆ·è¾“å…¥æ—¶æ ¼å¼åŒ–æ•°æ®
- **åŠ¨æ€è¡¨å•**ï¼šå¯ä»¥æ ¹æ®æŸä¸ªå­—æ®µçš„å€¼æ˜¾ç¤º/éšè—å…¶ä»–å­—æ®µ

```jsx
// å®æ—¶éªŒè¯ç¤ºä¾‹
function ValidatedInput() {
  const [value, setValue] = useState('');
  const [error, setError] = useState('');

  const handleChange = (e) => {
    const newValue = e.target.value;
    setValue(newValue);
    
    // å®æ—¶éªŒè¯
    if (newValue.length < 3) {
      setError('è‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
    } else if (!/^[a-zA-Z]+$/.test(newValue)) {
      setError('åªèƒ½åŒ…å«å­—æ¯');
    } else {
      setError('');
    }
  };

  return (
    <div>
      <input value={value} onChange={handleChange} />
      {error && <span style={{color: 'red'}}>{error}</span>}
    </div>
  );
}
```

---

## éå—æ§ç»„ä»¶

### å®ç°æ€è·¯

1. ä½¿ç”¨ `defaultValue` è®¾ç½®åˆå§‹å€¼ï¼ˆè€Œé `value`ï¼‰
2. é€šè¿‡ `ref` è·å– DOM èŠ‚ç‚¹
3. åœ¨éœ€è¦æ—¶ï¼ˆå¦‚æäº¤ï¼‰é€šè¿‡ ref è¯»å–å€¼

### ä»£ç ç¤ºä¾‹

```jsx
// åŸºç¡€éå—æ§è¾“å…¥æ¡†
function UncontrolledInput() {
  const inputRef = useRef(null);

  const handleSubmit = () => {
    // é€šè¿‡ ref è·å–å½“å‰å€¼
    console.log('è¾“å…¥å€¼ï¼š', inputRef.current.value);
  };

  return (
    <div>
      <input 
        type="text" 
        defaultValue="åˆå§‹å€¼"
        ref={inputRef}
      />
      <button onClick={handleSubmit}>è·å–å€¼</button>
    </div>
  );
}

// éå—æ§è¡¨å•
function UncontrolledForm() {
  const usernameRef = useRef(null);
  const emailRef = useRef(null);
  const ageRef = useRef(null);

  const handleSubmit = (e) => {
    e.preventDefault();
    
    const formData = {
      username: usernameRef.current.value,
      email: emailRef.current.value,
      age: ageRef.current.value
    };
    
    console.log('æäº¤æ•°æ®ï¼š', formData);
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        ref={usernameRef}
        defaultValue=""
        placeholder="ç”¨æˆ·å"
      />
      <input
        ref={emailRef}
        defaultValue=""
        placeholder="é‚®ç®±"
      />
      <input
        ref={ageRef}
        type="number"
        defaultValue=""
        placeholder="å¹´é¾„"
      />
      <button type="submit">æäº¤</button>
    </form>
  );
}
```

### æ¨¡æ‹Ÿå®ç°ï¼šéå—æ§ç»„ä»¶æœºåˆ¶

```javascript
// æ¨¡æ‹Ÿéå—æ§ç»„ä»¶çš„æ ¸å¿ƒæœºåˆ¶
class UncontrolledComponentSimulator {
  constructor(defaultValue = '') {
    this.defaultValue = defaultValue;
    this.inputElement = null;
  }

  // åˆ›å»º ref å¯¹è±¡
  createRef() {
    return {
      current: null
    };
  }

  // æ¸²æŸ“å‡½æ•°
  render(container) {
    const input = document.createElement('input');
    input.type = 'text';
    input.value = this.defaultValue; // åªè®¾ç½®åˆå§‹å€¼
    
    // ä¸ç›‘å¬ input äº‹ä»¶ï¼Œè®© DOM è‡ªå·±ç®¡ç†çŠ¶æ€
    // è¿™æ˜¯éå—æ§ç»„ä»¶çš„å…³é”®ç‰¹å¾
    
    this.inputElement = input;
    container.appendChild(input);
    
    return input; // è¿”å› DOM å¼•ç”¨ï¼ˆæ¨¡æ‹Ÿ refï¼‰
  }

  // è·å–å½“å‰å€¼ï¼ˆæ¨¡æ‹Ÿé€šè¿‡ ref è®¿é—®ï¼‰
  getValue() {
    return this.inputElement ? this.inputElement.value : '';
  }

  // è®¾ç½®å€¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
  setValue(newValue) {
    if (this.inputElement) {
      this.inputElement.value = newValue;
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const uncontrolled = new UncontrolledComponentSimulator('é»˜è®¤å€¼');
const inputRef = uncontrolled.render(document.getElementById('root'));

// ç¨åè·å–å€¼
setTimeout(() => {
  console.log('å½“å‰å€¼ï¼š', uncontrolled.getValue());
}, 3000);
```

### æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹ï¼ˆéå—æ§ç»„ä»¶çš„å…¸å‹åœºæ™¯ï¼‰

```jsx
function FileUpload() {
  const fileInputRef = useRef(null);

  const handleUpload = () => {
    const file = fileInputRef.current.files[0];
    if (file) {
      console.log('æ–‡ä»¶åï¼š', file.name);
      console.log('æ–‡ä»¶å¤§å°ï¼š', file.size);
      console.log('æ–‡ä»¶ç±»å‹ï¼š', file.type);
      
      // æ‰§è¡Œä¸Šä¼ é€»è¾‘
      const formData = new FormData();
      formData.append('file', file);
      // fetch('/upload', { method: 'POST', body: formData });
    }
  };

  return (
    <div>
      <input 
        type="file" 
        ref={fileInputRef}
      />
      <button onClick={handleUpload}>ä¸Šä¼ </button>
    </div>
  );
}
```

---

## å—æ§ vs éå—æ§å¯¹æ¯”

| ç‰¹æ€§ | å—æ§ç»„ä»¶ | éå—æ§ç»„ä»¶ |
|------|---------|-----------|
| **æ•°æ®æº** | React state | DOM è‡ªèº« |
| **è·å–å€¼** | ç›´æ¥ä» state è¯»å– | é€šè¿‡ ref è¯»å– |
| **æ›´æ–°æ–¹å¼** | onChange + setState | DOM è‡ªåŠ¨æ›´æ–° |
| **åˆå§‹å€¼** | value | defaultValue |
| **å®æ—¶éªŒè¯** | âœ… å®¹æ˜“å®ç° | âŒ è¾ƒéš¾å®ç° |
| **æ€§èƒ½** | æ¯æ¬¡è¾“å…¥éƒ½è§¦å‘æ¸²æŸ“ | ä¸è§¦å‘æ¸²æŸ“ |
| **ä»£ç é‡** | è¾ƒå¤šï¼ˆéœ€è¦äº‹ä»¶å¤„ç†ï¼‰ | è¾ƒå°‘ |
| **é€‚ç”¨åœºæ™¯** | éœ€è¦å®æ—¶äº¤äº’çš„è¡¨å• | ç®€å•è¡¨å•ã€æ–‡ä»¶ä¸Šä¼  |

---

## æ··åˆä½¿ç”¨ç¤ºä¾‹

```jsx
// å®é™…é¡¹ç›®ä¸­å¯èƒ½æ··åˆä½¿ç”¨ä¸¤ç§æ–¹å¼
function MixedForm() {
  // å—æ§ï¼šéœ€è¦å®æ—¶éªŒè¯çš„å­—æ®µ
  const [email, setEmail] = useState('');
  const [emailError, setEmailError] = useState('');
  
  // éå—æ§ï¼šç®€å•å­—æ®µ
  const nameRef = useRef(null);
  const phoneRef = useRef(null);
  
  // éå—æ§ï¼šæ–‡ä»¶ä¸Šä¼ 
  const fileRef = useRef(null);

  const validateEmail = (value) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
      setEmailError('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
    } else {
      setEmailError('');
    }
  };

  const handleEmailChange = (e) => {
    const value = e.target.value;
    setEmail(value);
    validateEmail(value);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    const formData = {
      name: nameRef.current.value,
      email: email,
      phone: phoneRef.current.value,
      file: fileRef.current.files[0]
    };
    
    if (!emailError) {
      console.log('æäº¤ï¼š', formData);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* éå—æ§ */}
      <input ref={nameRef} placeholder="å§“å" />
      
      {/* å—æ§ï¼šéœ€è¦å®æ—¶éªŒè¯ */}
      <div>
        <input 
          value={email}
          onChange={handleEmailChange}
          placeholder="é‚®ç®±"
        />
        {emailError && <span style={{color: 'red'}}>{emailError}</span>}
      </div>
      
      {/* éå—æ§ */}
      <input ref={phoneRef} placeholder="ç”µè¯" />
      
      {/* éå—æ§ï¼šæ–‡ä»¶ä¸Šä¼  */}
      <input type="file" ref={fileRef} />
      
      <button type="submit" disabled={!!emailError}>æäº¤</button>
    </form>
  );
}
```

---

## å¸¸è§é—®é¢˜

### 1. å¦‚ä½•é€‰æ‹©å—æ§ vs éå—æ§ï¼Ÿ

**ä½¿ç”¨å—æ§ç»„ä»¶çš„åœºæ™¯ï¼š**

- éœ€è¦å®æ—¶éªŒè¯è¾“å…¥
- éœ€è¦æ ¹æ®è¾“å…¥åŠ¨æ€æ˜¾ç¤º/éšè—å…¶ä»–å…ƒç´ 
- éœ€è¦æ ¼å¼åŒ–ç”¨æˆ·è¾“å…¥ï¼ˆå¦‚ç”µè¯å·ç ã€ä¿¡ç”¨å¡å·ï¼‰
- éœ€è¦ç¦ç”¨æäº¤æŒ‰é’®ç›´åˆ°æ‰€æœ‰å­—æ®µæœ‰æ•ˆ
- å¤šä¸ªè¾“å…¥éœ€è¦ç›¸äº’ä¾èµ–

**ä½¿ç”¨éå—æ§ç»„ä»¶çš„åœºæ™¯ï¼š**

- ç®€å•è¡¨å•ï¼Œåªåœ¨æäº¤æ—¶éœ€è¦å€¼
- æ–‡ä»¶ä¸Šä¼ ï¼ˆ`<input type="file">` å¿…é¡»æ˜¯éå—æ§çš„ï¼‰
- ä¸é React ä»£ç é›†æˆ
- æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…é¢‘ç¹æ¸²æŸ“ï¼‰

### 2. ä¸ºä»€ä¹ˆæ–‡ä»¶ä¸Šä¼ å¿…é¡»ç”¨éå—æ§ç»„ä»¶ï¼Ÿ

å› ä¸ºæ–‡ä»¶è¾“å…¥çš„å€¼åªèƒ½ç”±ç”¨æˆ·è®¾ç½®ï¼ˆå®‰å…¨åŸå› ï¼‰ï¼Œä¸èƒ½é€šè¿‡ JavaScript ç¼–ç¨‹è®¾ç½®ï¼Œæ‰€ä»¥ `<input type="file">` åœ¨ React ä¸­å§‹ç»ˆæ˜¯éå—æ§ç»„ä»¶ã€‚

```jsx
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ref
<input type="file" ref={fileRef} />

// âŒ é”™è¯¯ï¼šä¸èƒ½ä½¿ç”¨ value
<input type="file" value={fileValue} /> // ä¼šæŠ¥é”™
```

### 3. defaultValue vs value çš„åŒºåˆ«ï¼Ÿ

```jsx
// valueï¼šå—æ§ï¼ŒReact æ§åˆ¶å€¼
<input value={state} onChange={handler} />

// defaultValueï¼šéå—æ§ï¼Œåªè®¾ç½®åˆå§‹å€¼
<input defaultValue="åˆå§‹å€¼" ref={ref} />

// âŒ é”™è¯¯ï¼šä¸èƒ½åŒæ—¶ä½¿ç”¨
<input value={state} defaultValue="åˆå§‹å€¼" /> // ä¼šè­¦å‘Š
```

### 4. å—æ§ç»„ä»¶çš„æ€§èƒ½é—®é¢˜å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

```jsx
// é—®é¢˜ï¼šæ¯æ¬¡è¾“å…¥éƒ½è§¦å‘æ¸²æŸ“
function SlowForm() {
  const [value, setValue] = useState('');
  return <input value={value} onChange={e => setValue(e.target.value)} />;
}

// ä¼˜åŒ–1ï¼šä½¿ç”¨ debounce
function OptimizedForm1() {
  const [value, setValue] = useState('');
  const debouncedSetValue = useMemo(
    () => debounce(setValue, 300),
    []
  );
  
  return (
    <input 
      defaultValue={value}
      onChange={e => debouncedSetValue(e.target.value)} 
    />
  );
}

// ä¼˜åŒ–2ï¼šå¤§è¡¨å•æ‹†åˆ†æˆå°ç»„ä»¶
function OptimizedForm2() {
  return (
    <form>
      <InputField name="username" />
      <InputField name="email" />
      <InputField name="phone" />
    </form>
  );
}

// ä¼˜åŒ–3ï¼šä½¿ç”¨ useTransitionï¼ˆReact 18+ï¼‰
function OptimizedForm3() {
  const [value, setValue] = useState('');
  const [isPending, startTransition] = useTransition();
  
  const handleChange = (e) => {
    startTransition(() => {
      setValue(e.target.value);
    });
  };
  
  return <input value={value} onChange={handleChange} />;
}
```

### 5. å¦‚ä½•å°†éå—æ§ç»„ä»¶è½¬æ¢ä¸ºå—æ§ç»„ä»¶ï¼Ÿ

```jsx
// éå—æ§
function Uncontrolled() {
  const ref = useRef(null);
  return <input ref={ref} defaultValue="åˆå§‹å€¼" />;
}

// è½¬æ¢ä¸ºå—æ§
function Controlled() {
  const [value, setValue] = useState('åˆå§‹å€¼');
  return (
    <input 
      value={value} 
      onChange={e => setValue(e.target.value)} 
    />
  );
}
```

### 6. React å¦‚ä½•æ£€æµ‹å—æ§/éå—æ§åˆ‡æ¢ï¼Ÿ

React ä¼šè­¦å‘Šå¦‚æœç»„ä»¶ä»å—æ§å˜ä¸ºéå—æ§ï¼ˆæˆ–ç›¸åï¼‰ï¼š

```jsx
function ProblematicComponent({ isControlled }) {
  const [value, setValue] = useState('');
  
  // âŒ é”™è¯¯ï¼šæ ¹æ®æ¡ä»¶åœ¨å—æ§/éå—æ§ä¹‹é—´åˆ‡æ¢
  return (
    <input
      value={isControlled ? value : undefined}
      onChange={e => setValue(e.target.value)}
    />
  );
}

// âœ… æ­£ç¡®ï¼šå§‹ç»ˆä¿æŒå—æ§
function CorrectComponent({ isControlled }) {
  const [value, setValue] = useState('');
  
  return (
    <input
      value={value || ''} // ç¡®ä¿ value æ°¸è¿œä¸æ˜¯ undefined
      onChange={e => setValue(e.target.value)}
    />
  );
}
```

### 7. è¡¨å•åº“å¦‚ä½•å¤„ç†å—æ§ç»„ä»¶ï¼Ÿ

æµè¡Œçš„è¡¨å•åº“ï¼ˆå¦‚ Formikã€React Hook Formï¼‰çš„ç­–ç•¥ï¼š

```jsx
// Formikï¼šå®Œå…¨å—æ§
<Formik initialValues={{ email: '' }}>
  <Field name="email" />
</Formik>

// React Hook Formï¼šéå—æ§ + ref
function App() {
  const { register, handleSubmit } = useForm();
  
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register("email")} />
    </form>
  );
}
```

React Hook Form ä½¿ç”¨éå—æ§æ–¹å¼ä»¥æé«˜æ€§èƒ½ï¼Œå› ä¸ºå®ƒä¸ä¼šåœ¨æ¯æ¬¡è¾“å…¥æ—¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

---

## æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. **å—æ§ç»„ä»¶**ï¼šReact state æ˜¯å”¯ä¸€æ•°æ®æºï¼Œé€šè¿‡ `value` + `onChange` å®ç°åŒå‘ç»‘å®š
2. **éå—æ§ç»„ä»¶**ï¼šDOM æ˜¯æ•°æ®æºï¼Œé€šè¿‡ `ref` + `defaultValue` è®¿é—®å€¼
3. **é€‰æ‹©åŸåˆ™**ï¼šéœ€è¦å®æ—¶äº¤äº’ç”¨å—æ§ï¼Œç®€å•è¡¨å•ç”¨éå—æ§
4. **æ€§èƒ½è€ƒè™‘**ï¼šå—æ§ç»„ä»¶æ¯æ¬¡è¾“å…¥éƒ½æ¸²æŸ“ï¼Œå¯ç”¨ debounceã€ç»„ä»¶æ‹†åˆ†ã€useTransition ä¼˜åŒ–
5. **ç‰¹æ®Šæƒ…å†µ**ï¼šæ–‡ä»¶ä¸Šä¼ å¿…é¡»ç”¨éå—æ§ç»„ä»¶
6. **æ··åˆä½¿ç”¨**ï¼šå®é™…é¡¹ç›®ä¸­å¯æ ¹æ®å­—æ®µç‰¹ç‚¹çµæ´»é€‰æ‹©
