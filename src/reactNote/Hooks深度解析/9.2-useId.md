# 9.2 useId

`useId` 是 React 18 引入的一个用于生成**唯一 ID** 的 Hook。它主要用于无障碍功能（Accessibility, a11y）属性，如 `aria-labelledby`、`htmlFor` 等，确保在服务端渲染（SSR）和客户端 hydration 过程中 ID 保持一致。

## 1. 核心作用

在 React 组件中，如果我们手动写死 ID（如 `id="input-1"`），当页面上有多个该组件实例时，ID 就会冲突。
如果我们用 `Math.random()` 生成 ID，服务端生成的 ID 和客户端生成的 ID 会不一致（Hydration Mismatch），导致 React 报错或重渲染。

`useId` 解决了这两个问题：
1.  **唯一性**：为每个组件实例生成唯一的 ID。
2.  **稳定性**：保证 SSR 和客户端生成的 ID 严格一致。

## 2. 语法

```javascript
const id = useId();
```

返回值是一个包含冒号的字符串，例如 `":r0:"`, `":r1:"` 等。

## 3. 使用示例

### 3.1 关联 Label 和 Input

这是最典型的用法。通过 `htmlFor` 和 `id` 将标签与输入框关联，提升可访问性。

```javascript
import { useId } from 'react';

function PasswordField() {
  const id = useId();

  return (
    <div>
      <label htmlFor={id}>Password:</label>
      <input id={id} type="password" aria-describedby={`${id}-hint`} />
      <p id={`${id}-hint`}>
        The password should contain at least 18 characters
      </p>
    </div>
  );
}
```

即使你在页面上渲染了 100 个 `PasswordField`，每个实例的 ID 都是唯一的，不会冲突。

### 3.2 多个相关元素的 ID

如果一个组件需要多个 ID，不需要调用多次 `useId`，可以基于同一个 ID 添加后缀。

```javascript
function Form() {
  const id = useId();
  
  return (
    <form>
      <label htmlFor={`${id}-firstName`}>First Name</label>
      <input id={`${id}-firstName`} type="text" />
      
      <label htmlFor={`${id}-lastName`}>Last Name</label>
      <input id={`${id}-lastName`} type="text" />
    </form>
  );
}
```

## 4. 注意事项

1.  **不要用于 CSS 选择器**：`useId` 生成的字符串包含冒号（如 `:r1:`），这在 CSS 选择器中需要转义（如 `querySelector('#\\:r1\\:')`），非常麻烦且不推荐。它主要用于 DOM 属性关联。
2.  **不要用于列表 key**：列表的 key 应该来源于数据本身（如数据库 ID），而不是 `useId`。因为当列表项顺序变化时，`useId` 生成的 ID 是基于组件树结构的，不会随数据移动，这会导致状态混乱。
    *   ✅ `key={todo.id}`
    *   ❌ `key={useId()}`

## 5. 原理简析

React 在内部维护了一个全局的计数器（针对每个 Root）。在遍历组件树（Render 阶段）时，根据组件在树中的层级结构生成稳定的 ID。因为 SSR 和客户端 hydration 遍历树的顺序是一致的，所以生成的 ID 也是一致的。
