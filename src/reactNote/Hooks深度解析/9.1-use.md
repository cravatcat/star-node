# 9.1 use (React 19)

`use` 是 React 19 (目前处于 Canary/Beta 阶段) 引入的一个全新的 API。与其说它是一个 Hook，不如说它是一个**通用的资源读取器**。它可以读取 Promise、Context 等资源的值。

## 1. 核心特性

`use` 有两个打破常规 Hook 限制的特点：
1.  **可以在条件语句和循环中使用**：这是与普通 Hook（如 `useState`）最大的区别。
2.  **与 Suspense 集成**：当读取 Promise 时，如果 Promise 处于 pending 状态，`use` 会挂起组件（触发 Suspense），直到 Promise resolve。

## 2. 语法

```javascript
const value = use(resource);
```

*   **resource**: 可以是一个 Promise 或一个 Context 对象。

## 3. 使用场景

### 3.1 读取 Promise (数据获取)

以前我们需要 `useEffect` + `useState` 来处理数据获取，现在可以直接在渲染函数中用 `use` 读取 Promise。

*注意：通常 Promise 是在组件外部或父组件创建的，或者是通过 Server Components 传递下来的。如果在组件内部直接创建 Promise，需要加缓存，否则每次渲染都会重新请求。*

```javascript
import { use, Suspense } from 'react';

// 模拟一个数据请求 Promise
const fetchData = fetch('https://api.example.com/data').then(res => res.json());

function DataComponent() {
  // 读取 Promise 的值
  // 如果 Promise 还没 resolve，组件会挂起
  const data = use(fetchData);
  
  return <div>Data: {data.message}</div>;
}

function App() {
  return (
    <Suspense fallback={<p>Loading...</p>}>
      <DataComponent />
    </Suspense>
  );
}
```

### 3.2 读取 Context

在此之前，我们只能在组件顶层使用 `useContext`。现在，`use` 允许我们在条件语句中灵活读取 Context。

```javascript
import { createContext, use } from 'react';

const ThemeContext = createContext('light');

function Button({ showTheme }) {
  if (showTheme) {
    // ✅ 合法：在 if 语句中使用 use 读取 Context
    const theme = use(ThemeContext);
    return <button className={theme}>Themed Button</button>;
  }
  
  // ❌ 非法：如果是 useContext，必须放在顶层，不能放在这里
  // const theme = useContext(ThemeContext); 
  
  return <button>Default Button</button>;
}
```

## 4. 为什么叫 `use` 而不是 `usePromise`？

因为它不仅用于 Promise，还用于 Context，未来可能支持更多类型的资源（如 Observables）。它是一个通用的“解包”操作符。

## 5. 注意事项

1.  **必须在组件或 Hook 内部调用**：虽然它不受“顶层调用”规则限制，但仍然必须在 React 的渲染上下文中使用。
2.  **不要在渲染中创建 Promise**：
    ```javascript
    function Bad() {
      // ❌ 错误：每次渲染都创建新 Promise，导致无限循环或重新请求
      const data = use(fetch('/api').then(res => res.json())); 
      return ...
    }
    ```
    Promise 应该由框架（如 Next.js, Remix）传递，或者用缓存库（如 React Query, useMemo）管理。

## 6. 总结

`use` API 极大地简化了异步数据的处理流程，让我们可以像写同步代码一样写异步组件，同时保持了 Hook 的组合能力。它是 React 向“全栈组件化”和“Server Components”迈进的重要一步。
