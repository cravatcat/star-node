# 6.4 自动优化：React Compiler (React 19+)

`React Compiler`（曾用名 React Forget）是 React 团队推出的自动记忆化编译器。它旨在解决 React 长期以来的痛点：手动管理依赖（`useMemo`、`useCallback`、`React.memo`）带来的心智负担和代码复杂性。

## 1. 为什么需要它？

### 1.1 React 的默认行为：粗粒度更新

在 React 18 及之前，当父组件状态更新时，**默认会递归重新渲染所有子组件**。
为了避免不必要的重渲染，开发者不得不大量使用手动优化：

- `React.memo`：阻止子组件重渲染。
- `useMemo`：缓存对象引用，防止破坏子组件的 `memo`。
- `useCallback`：缓存函数引用，防止破坏子组件的 `memo`。

### 1.2 手动优化的弊端

1. **心智负担重**：你需要时刻思考“这个对象需不需要缓存？”、“这个数组是不是新的引用？”。
2. **容易出错**：依赖数组（deps array）很容易漏写或写错，导致闭包陷阱或无限循环。
3. **代码污染**：业务逻辑被大量的 `useMemo` 和 `useCallback` 包裹，降低了可读性。

## 2. React Compiler 如何工作？

React Compiler 是一个构建时工具（Babel 插件），它会在代码编译阶段自动分析你的组件，理解数据流向，并自动插入记忆化逻辑。

### 2.1 自动记忆化 (Automatic Memoization)

编译器会将你的组件代码转换为高度优化的版本。它不仅缓存组件本身，还会缓存组件内部的计算结果。

**编译前（开发者写的代码）：**

```javascript
function FriendList({ friends }) {
  const onlineCount = friends.filter(f => f.isOnline).length;
  
  return (
    <div className="friend-list">
      {friends.map(friend => (
        <Friend key={friend.id} friend={friend} />
      ))}
      <div>Online: {onlineCount}</div>
    </div>
  );
}
```

**编译后（概念上的等价代码）：**

```javascript
function FriendList({ friends }) {
  const $ = _c(2); // 编译器的内部缓存 hook

  let onlineCount;
  // 检查 friends 是否变化
  if ($[0] !== friends) {
    onlineCount = friends.filter(f => f.isOnline).length;
    $[0] = friends;
    $[1] = onlineCount;
  } else {
    onlineCount = $[1];
  }

  // ... 类似的逻辑用于 JSX 返回结果
  // 只有当 friends 变化时，JSX 才会重新创建
}
```

### 2.2 实现“细粒度更新”的效果

虽然 React 运行时依然是自顶向下的渲染模型，但 React Compiler 通过极度精准的缓存，实现了类似 SolidJS 或 Vue 的“细粒度更新”效果。
如果父组件更新了，但传递给子组件的 props 没有变，Compiler 生成的代码会自动跳过子组件的重新创建和渲染。

## 3. 如何使用？

### 3.1 安装

React Compiler 通常作为 Babel 插件使用。

```bash
npm install babel-plugin-react-compiler
```

### 3.2 配置 (Vite 示例)

```javascript
// vite.config.js
const ReactCompilerConfig = { /* ... */ };

export default defineConfig({
  plugins: [
    react({
      babel: {
        plugins: [
          ["babel-plugin-react-compiler", ReactCompilerConfig],
        ],
      },
    }),
  ],
});
```

### 3.3 ESLint 插件

官方提供了配套的 ESLint 插件，用于检查你的代码是否符合编译器的要求（主要是不能违反 React 的规则）。

```bash
npm install eslint-plugin-react-compiler
```

## 4. 常见问题

### 4.1 我还需要写 useMemo 吗？

**基本不需要。** Compiler 会自动处理绝大多数场景。你只需要在极少数极端优化的场景下手动编写。

### 4.2 它能兼容老代码吗？

**可以。** Compiler 只会优化符合规范的函数组件。如果代码太复杂或违反了 React 规则，Compiler 会选择跳过优化，退回到默认的 React 行为，不会破坏现有逻辑。

### 4.3 React 19 是必须的吗？

React Compiler 配合 React 19 效果最好，但它也可以通过垫片（shim）在 React 17/18 上运行。
