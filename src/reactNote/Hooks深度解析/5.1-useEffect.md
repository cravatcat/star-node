# 5.1 useEffect ğŸŒŸ

`useEffect` æ˜¯ React ä¸­å¤„ç†å‰¯ä½œç”¨ï¼ˆSide Effectsï¼‰çš„æ ¸å¿ƒ Hookã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨å‡½æ•°ç»„ä»¶ä¸­æ‰§è¡Œæ•°æ®è·å–ã€è®¢é˜…ã€æ‰‹åŠ¨ä¿®æ”¹ DOM ç­‰æ“ä½œã€‚

## 1. åŸç†è®²è§£

åœ¨ç±»ç»„ä»¶ä¸­ï¼Œå‰¯ä½œç”¨é€šå¸¸åœ¨ `componentDidMount`ã€`componentDidUpdate` å’Œ `componentWillUnmount` ä¸­å¤„ç†ã€‚`useEffect` å°†è¿™äº›ç”Ÿå‘½å‘¨æœŸç»Ÿä¸€ä¸ºä¸€ä¸ª APIã€‚

### æ ¸å¿ƒæœºåˆ¶

1. **å‰¯ä½œç”¨æ‰§è¡Œ**ï¼š`useEffect` ä¼ å…¥çš„å›è°ƒå‡½æ•°ä¼šåœ¨ç»„ä»¶æ¸²æŸ“**æäº¤åˆ°å±å¹•ä¹‹å**å¼‚æ­¥æ‰§è¡Œã€‚è¿™ä¿è¯äº†å‰¯ä½œç”¨ä¸ä¼šé˜»å¡æµè§ˆå™¨çš„ç»˜åˆ¶ã€‚
2. **æ¸…ç†æœºåˆ¶**ï¼šå›è°ƒå‡½æ•°å¯ä»¥è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼ˆcleanup functionï¼‰ã€‚React ä¼šåœ¨ç»„ä»¶å¸è½½æ—¶ï¼Œæˆ–è€…ä¸‹ä¸€æ¬¡ Effect æ‰§è¡Œä¹‹å‰è°ƒç”¨å®ƒã€‚
3. **ä¾èµ–è¿½è¸ª**ï¼šé€šè¿‡ä¾èµ–æ•°ç»„ï¼ˆdependency arrayï¼‰æ§åˆ¶ Effect çš„æ‰§è¡Œæ—¶æœºã€‚

### æ¨¡æ‹Ÿå®ç°

æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€åŒ–çš„æ¨¡å‹æ¥ç†è§£ `useEffect` çš„å·¥ä½œåŸç†ã€‚å®ƒä¸»è¦ä¾èµ–äºä¸¤ä¸ªå˜é‡ï¼š`lastDeps`ï¼ˆä¸Šä¸€æ¬¡çš„ä¾èµ–ï¼‰å’Œ `cleanup`ï¼ˆä¸Šä¸€æ¬¡çš„æ¸…ç†å‡½æ•°ï¼‰ã€‚

```javascript
// æ¨¡æ‹Ÿçš„å…¨å±€çŠ¶æ€
let lastDeps; // å­˜å‚¨ä¸Šä¸€æ¬¡çš„ä¾èµ–æ•°ç»„
let cleanup; // å­˜å‚¨ä¸Šä¸€æ¬¡çš„æ¸…ç†å‡½æ•°

function useEffect(callback, deps) {
  const noDeps = !deps;
  const hasChangedDeps = deps ? !deps.every((el, i) => el === lastDeps?.[i]) : true;

  // å¦‚æœæ²¡æœ‰ä¾èµ–æ•°ç»„ï¼Œæˆ–è€…ä¾èµ–å‘ç”Ÿäº†å˜åŒ–
  if (noDeps || hasChangedDeps) {
    // 1. æ‰§è¡Œä¸Šä¸€æ¬¡çš„æ¸…ç†å‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
    if (cleanup) {
      cleanup();
    }

    // 2. æ‰§è¡Œå½“å‰çš„å‰¯ä½œç”¨ï¼Œå¹¶ä¿å­˜è¿”å›çš„æ¸…ç†å‡½æ•°
    // æ³¨æ„ï¼šçœŸå®çš„ React ä¸­ï¼Œè¿™é‡Œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„
    const newCleanup = callback();
    cleanup = newCleanup;

    // 3. æ›´æ–°ä¾èµ–
    lastDeps = deps;
  }
}
```

> **æ³¨æ„**ï¼šçœŸå®çš„ React å®ç°è¦å¤æ‚å¾—å¤šï¼Œæ¶‰åŠåˆ° Fiber èŠ‚ç‚¹çš„ `updateQueue` å’Œ `effectTag`ï¼Œä»¥åŠè°ƒåº¦å™¨çš„å¼‚æ­¥æ‰§è¡Œé€»è¾‘ã€‚

## 2. ä¾èµ–æ•°ç»„æœºåˆ¶

`useEffect` çš„ç¬¬äºŒä¸ªå‚æ•°å†³å®šäº†å®ƒä½•æ—¶æ‰§è¡Œã€‚React ä½¿ç”¨ `Object.is` ç®—æ³•å¯¹ä¾èµ–é¡¹è¿›è¡Œ**æµ…æ¯”è¾ƒ**ã€‚

- **ä¸ä¼ å‚æ•°** (`useEffect(() => {})`)ï¼šæ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œã€‚
- **ç©ºæ•°ç»„** (`useEffect(() => {}, [])`)ï¼šä»…åœ¨ç»„ä»¶æŒ‚è½½ï¼ˆMountï¼‰åæ‰§è¡Œä¸€æ¬¡ï¼Œç±»ä¼¼ `componentDidMount`ã€‚
- **æœ‰ä¾èµ–é¡¹** (`useEffect(() => {}, [prop, state])`)ï¼šä»…å½“ä¾èµ–é¡¹å˜åŒ–æ—¶æ‰§è¡Œã€‚

### æµ…æ¯”è¾ƒé™·é˜±

```javascript
// âŒ é”™è¯¯ç¤ºèŒƒï¼šä¾èµ–å¯¹è±¡å¼•ç”¨
useEffect(() => {
  console.log('Options changed');
}, [{ id: 1 }]); // æ¯æ¬¡æ¸²æŸ“ { id: 1 } éƒ½æ˜¯æ–°å¯¹è±¡ï¼Œå¯¼è‡´æ­»å¾ªç¯æˆ–é¢‘ç¹æ‰§è¡Œ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. å°†å¯¹è±¡æ‹†åˆ†ä¸ºåŸºæœ¬ç±»å‹ä¾èµ–ã€‚
2. ä½¿ç”¨ `useMemo` ç¼“å­˜å¯¹è±¡ã€‚
3. å°†å¯¹è±¡ç§»åˆ° Effect å†…éƒ¨ï¼ˆå¦‚æœåªåœ¨ Effect ä¸­ä½¿ç”¨ï¼‰ã€‚

## 3. æ‰§è¡Œæ—¶æœº

`useEffect` æ˜¯**å¼‚æ­¥**çš„ã€‚

1. React æ›´æ–° DOMã€‚
2. æµè§ˆå™¨ç»˜åˆ¶å±å¹•ã€‚
3. React æ‰§è¡Œ `useEffect` å›è°ƒã€‚

è¿™ä¸ `useLayoutEffect` ä¸åŒï¼Œåè€…æ˜¯åœ¨ DOM æ›´æ–°åã€æµè§ˆå™¨ç»˜åˆ¶å‰**åŒæ­¥**æ‰§è¡Œã€‚

## 4. å¸¸è§é™·é˜±

### 4.1 é—­åŒ…é™·é˜± (Stale Closures)

Effect æ•è·çš„æ˜¯å®šä¹‰æ—¶çš„å˜é‡å¿«ç…§ã€‚å¦‚æœä¾èµ–é¡¹æ²¡å†™å…¨ï¼ŒEffect å†…éƒ¨çœ‹åˆ°çš„å˜é‡å¯èƒ½æ˜¯æ—§çš„ã€‚

```javascript
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const id = setInterval(() => {
      console.log(count); // âŒ æ°¸è¿œæ‰“å° 0ï¼Œå› ä¸º count æ•è·çš„æ˜¯åˆå§‹å€¼
    }, 1000);
    return () => clearInterval(id);
  }, []); // ç¼ºå°‘ count ä¾èµ–

  return <h1>{count}</h1>;
}
```

**ä¿®æ­£**ï¼š

1. æ·»åŠ ä¾èµ–ï¼š`[count]`ï¼ˆä¼šå¯¼è‡´å®šæ—¶å™¨é¢‘ç¹é‡ç½®ï¼‰ã€‚
2. ä½¿ç”¨å‡½æ•°å¼æ›´æ–°ï¼š`setCount(c => c + 1)`ï¼ˆæ¨èï¼‰ã€‚
3. ä½¿ç”¨ `useRef` ä¿å­˜æœ€æ–°å€¼ã€‚

### 4.2 æ— é™å¾ªç¯

å¦‚æœåœ¨ Effect ä¸­æ›´æ–°äº†çŠ¶æ€ï¼Œè€Œè¿™ä¸ªçŠ¶æ€åˆæ˜¯ Effect çš„ä¾èµ–ï¼Œå°±ä¼šå¯¼è‡´æ— é™å¾ªç¯ã€‚

```javascript
useEffect(() => {
  setCount(count + 1); // æ›´æ–° count
}, [count]); // ä¾èµ– count -> è§¦å‘æ›´æ–° -> å†æ¬¡æ‰§è¡Œ Effect -> æ— é™å¾ªç¯
```

### 4.3 å¿˜è®°æ¸…ç†

å¯¹äºè®¢é˜…ã€å®šæ—¶å™¨ã€DOM äº‹ä»¶ç›‘å¬ç­‰ï¼Œå¿…é¡»è¿”å›æ¸…ç†å‡½æ•°ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼æˆ–é€»è¾‘é”™è¯¯ã€‚

```javascript
useEffect(() => {
  const handleResize = () => console.log(window.innerWidth);
  window.addEventListener('resize', handleResize);
  
  // âœ… å¿…é¡»æ¸…ç†
  return () => window.removeEventListener('resize', handleResize);
}, []);
```

## 5. å¸¸è§é—®é¢˜ (FAQ)

### Q: `useEffect` å’Œ `componentDidMount` å®Œå…¨ä¸€æ ·å—ï¼Ÿ

**A**: ä¸å®Œå…¨ä¸€æ ·ã€‚`componentDidMount` ä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶ï¼Œè€Œ `useEffect` ä¸ä¼šã€‚å¦‚æœä½ éœ€è¦åœ¨ç»˜åˆ¶å‰æ“ä½œ DOMï¼ˆä¾‹å¦‚æµ‹é‡å…ƒç´ å¤§å°ï¼‰ï¼Œåº”è¯¥ä½¿ç”¨ `useLayoutEffect`ã€‚

### Q: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ Effect æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Ÿ

**A**: åœ¨ React 18 çš„ä¸¥æ ¼æ¨¡å¼ï¼ˆStrict Modeï¼‰å¼€å‘ç¯å¢ƒä¸‹ï¼ŒReact ä¼šç‰¹æ„æŒ‚è½½ã€å¸è½½ã€å†æŒ‚è½½ç»„ä»¶ï¼Œä»¥æ£€æŸ¥ Effect çš„æ¸…ç†é€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚ç”Ÿäº§ç¯å¢ƒä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚

### Q: å¦‚ä½•åœ¨ `useEffect` ä¸­ä½¿ç”¨ async/awaitï¼Ÿ

**A**: `useEffect` çš„å›è°ƒä¸èƒ½æ˜¯ async å‡½æ•°ï¼Œå› ä¸ºå®ƒéœ€è¦è¿”å›æ¸…ç†å‡½æ•°ï¼Œè€Œ async å‡½æ•°è¿”å› Promiseã€‚
æ­£ç¡®å†™æ³•ï¼š

```javascript
useEffect(() => {
  async function fetchData() {
    const data = await api.get();
    setData(data);
  }
  fetchData();
}, []);
```
